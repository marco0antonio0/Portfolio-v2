name: SSH to Cloudflare

on: [push]

jobs:
  Deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
        chmod +x cloudflared

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/runner.pem
        chmod 600 ~/.ssh/runner.pem
        export SSH_HOST=${{ secrets.SSH_HOST }}
        cat > ~/.ssh/config <<EOF
        Host runner-sh
            HostName $SSH_HOST
            User server
            IdentityFile ~/.ssh/runner.pem
            IdentitiesOnly yes
            ProxyCommand ./cloudflared access ssh --hostname %h
            ServerAliveInterval 60
        EOF

    - name: Build And Deploy
      run: |
        ssh -o StrictHostKeyChecking=no runner-sh << 'EOF'
        echo "[$(date)] Iniciando deploy no servidor..."
        echo "[$(date)] Verificando conexão SSH..."
        whoami
        echo "[$(date)] Usuário conectado: $(whoami)"
        echo "[$(date)] Acessando diretório alvo..."
        cd ${{ secrets.TARGET_DIR }}
        echo "[$(date)] Atualizando repositório..."
        git reset --hard origin/main
        git pull origin main --no-edit
        echo "[$(date)] Repositório atualizado"
        echo "[$(date)] Iniciando build do Docker Compose..."
        timeout 1200 docker-compose build --progress=plain
        if [ $? -eq 0 ]; then
          echo "[$(date)] Build concluído com sucesso"
        else
          echo "[$(date)] ERRO: Build falhou ou timeout (20min)"
          exit 1
        fi
        echo "[$(date)] Parando containers antigos..."
        docker-compose down --remove-orphans
        echo "[$(date)] Iniciando containers..."
        docker-compose up -d
        if [ $? -eq 0 ]; then
          echo "[$(date)] Containers iniciados com sucesso"
        else
          echo "[$(date)] ERRO: Falha ao iniciar containers"
          exit 1
        fi
        echo "[$(date)] Iniciando limpeza do sistema Docker..."
        # Tentar limpeza com retry para evitar conflito com operações simultâneas
        MAX_RETRIES=3
        RETRY_COUNT=0
        CLEANUP_SUCCESS=false

        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$CLEANUP_SUCCESS" = false ]; do
          echo "[$(date)] Tentativa de limpeza $(($RETRY_COUNT + 1))/$MAX_RETRIES..."
          if docker system prune -f > /dev/null 2>&1; then
            echo "[$(date)] Limpeza concluída com sucesso"
            CLEANUP_SUCCESS=true
          else
            echo "[$(date)] Limpeza falhou, aguardando 10 segundos..."
            sleep 10
            RETRY_COUNT=$(($RETRY_COUNT + 1))
          fi
        done

        if [ "$CLEANUP_SUCCESS" = false ]; then
          echo "[$(date)] AVISO: Limpeza do Docker não foi concluída após $MAX_RETRIES tentativas, mas deploy continua..."
        fi
        echo "[$(date)] Limpando chaves SSH conhecidas e cache..."
        rm -f ~/.ssh/known_hosts
        ssh-keygen -R ${{ secrets.SSH_HOST }} 2>/dev/null || true
        echo "[$(date)] Limpeza de chaves SSH concluída"
        echo "[$(date)] Verificando status final..."
        docker ps --format "table {{.Names}}\t{{.Status}}"
        echo "[$(date)] Deploy finalizado com sucesso!"
        EOF

    - name: Local cleanup
      run: |
        echo "[$(date)] Fazendo limpeza completa local no runner..."
        rm -f cloudflared
        rm -rf ~/.ssh
        echo "[$(date)] Limpeza completa local concluída"
